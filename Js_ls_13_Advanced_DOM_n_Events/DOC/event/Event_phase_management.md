В **DOM API** события проходят через три фазы: **захват (capturing)**, **цель (target)** и **всплытие (bubbling)**. 

Эти фазы определяют порядок, в котором обработчики событий срабатывают при взаимодействии с элементами DOM. Необходимо понимать, как работает код на фазах всплытия, захвата и как остановить всплытие:

---

### 1. Фазы событий в DOM:

Когда событие (например, `click`) происходит на элементе, оно проходит через следующие фазы:

1. **Фаза захвата (Capturing Phase)**:
   - Событие начинается с корня документа (`document`) и движется вниз по дереву DOM к целевому элементу (тому, на котором произошло событие).
   - Обработчики, зарегистрированные с опцией `{ capture: true }` в `addEventListener`, срабатывают на этой фазе.
   - Используется реже, но полезно для перехвата событий до их достижения цели.

2. **Фаза цели (Target Phase)**:
   - Событие достигает целевого элемента, на котором оно было инициировано.
   - Обработчики, привязанные к этому элементу, срабатывают независимо от того, зарегистрированы они для захвата или всплытия.

3. **Фаза всплытия (Bubbling Phase)**:
   - После достижения цели событие "всплывает" вверх по дереву DOM, от целевого элемента к его родителям, вплоть до `document` и `window`.
   - Большинство обработчиков событий по умолчанию регистрируются для этой фазы (если не указано `{ capture: false }` или не указано вовсе).

**Примечание**: Некоторые события, такие как `focus`, `blur` или `scroll`, не всплывают, но их можно перехватывать на фазе захвата или использовать аналоги, которые всплывают (например, `focusin` вместо `focus`).

---

### 2. Работа кода на фазе всплытия:

На фазе всплытия событие обрабатывается **снизу вверх** — от целевого элемента к его родителям. 

Это наиболее распространённый сценарий, так как большинство обработчиков событий по умолчанию регистрируются для фазы всплытия.

**Пример**:

```html
<div id="parent">
  <button id="child">Кликни меня</button>
</div>
<script>
  const parent = document.querySelector('#parent');
  const child = document.querySelector('#child');

  // Обработчик на дочернем элементе (фаза цели или всплытия)
  child.addEventListener('click', () => {
    console.log('Клик на кнопке (child)');
  });

  // Обработчик на родительском элементе (фаза всплытия)
  parent.addEventListener('click', () => {
    console.log('Клик на родителе (parent)');
  });

  // Обработчик на document (фаза всплытия)
  document.addEventListener('click', () => {
    console.log('Клик на document');
  });
</script>
```

**Что происходит при клике на кнопку**:
1. Событие `click` инициируется на элементе `<button>` (фаза цели).
2. Обработчик на `<button>` срабатывает первым.
3. Событие всплывает к `<div>` (родителю), вызывая его обработчик.
4. Событие продолжает всплывать к `document`, вызывая его обработчик.

**Вывод в консоль**:
```
Клик на кнопке (child)
Клик на родителе (parent)
Клик на document
```

**Особенности**:
- Порядок вызова обработчиков определяется иерархией DOM: от целевого элемента к корню.
- Если обработчик не привязан к элементу, он не сработает, даже если событие всплывает через этот элемент.

---

### 3. Работа кода на фазе захвата:

На фазе захвата событие обрабатывается **сверху вниз** — от корня документа к целевому элементу. **Чтобы обработчик срабатывал на этой фазе, нужно указать опцию `{ capture: true }` в `addEventListener`.**

**Пример**:

```html
<div id="parent">
  <button id="child">Кликни меня</button>
</div>
<script>
  const parent = document.querySelector('#parent');
  const child = document.querySelector('#child');

  // Обработчик на document (фаза захвата)
  document.addEventListener(
    'click',
    () => {
      console.log('Клик на document (захват)');
    },
    { capture: true }
  );

  // Обработчик на родительском элементе (фаза захвата)
  parent.addEventListener(
    'click',
    () => {
      console.log('Клик на родителе (захват)');
    },
    { capture: true }
  );

  // Обработчик на дочернем элементе (фаза цели)
  child.addEventListener('click', () => {
    console.log('Клик на кнопке (цель)');
  });
</script>
```

**Что происходит при клике на кнопку**:
1. Событие `click` начинается с `document` (фаза захвата).
2. Обработчик на `document` срабатывает первым, так как он зарегистрирован для фазы захвата.
3. Событие движется к `<div>` (родителю), вызывая его обработчик на фазе захвата.
4. Событие достигает `<button>` (цель), вызывая его обработчик.

**Вывод в консоль**:
```
Клик на document (захват)
Клик на родителе (захват)
Клик на кнопке (цель)
```

**Особенности**:
- Фаза захвата полезна, если нужно перехватить событие до того, как оно достигнет целевого элемента (например, для логирования или предотвращения обработки).
- Если на родительских элементах нет обработчиков с `{ capture: true }`, фаза захвата пропускается, и обработка начинается с фазы цели.

---

### 4. Остановка всплытия:

Всплытие событий можно остановить, чтобы предотвратить вызов обработчиков на родительских элементах. Для этого используются два метода объекта события (`event`):

- **`event.stopPropagation()`**:
  - Останавливает дальнейшее всплытие события (или его движение на фазе захвата).
  - Другие обработчики на текущем элементе всё равно сработают.

- **`event.stopImmediatePropagation()`**:
  - Останавливает всплытие и предотвращает выполнение других обработчиков на том же элементе.

**Пример с `stopPropagation`**:

```html
<div id="parent">
  <button id="child">Кликни меня</button>
</div>
<script>
  const parent = document.querySelector('#parent');
  const child = document.querySelector('#child');

  child.addEventListener('click', (event) => {
    console.log('Клик на кнопке');
    event.stopPropagation(); // Останавливаем всплытие
  });

  parent.addEventListener('click', () => {
    console.log('Клик на родителе'); // Не сработает
  });
</script>
```

**Вывод при клике на кнопку**:
```
Клик на кнопке
```

**Что происходит**:
- Обработчик на `<button>` срабатывает.
- `event.stopPropagation()` предотвращает всплытие события к `<div>`, поэтому обработчик на родителе не вызывается.

**Пример с `stopImmediatePropagation`**:

```html
<div id="parent">
  <button id="child">Кликни меня</button>
</div>
<script>
  const child = document.querySelector('#child');

  child.addEventListener('click', (event) => {
    console.log('Обработчик 1 на кнопке');
    event.stopImmediatePropagation(); // Останавливаем все дальнейшие обработчики
  });

  child.addEventListener('click', () => {
    console.log('Обработчик 2 на кнопке'); // Не сработает
  });

  document.querySelector('#parent').addEventListener('click', () => {
    console.log('Клик на родителе'); // Не сработает
  });
</script>
```

**Вывод при клике на кнопку**:
```
Обработчик 1 на кнопке
```

**Что происходит**:
- `event.stopImmediatePropagation()` останавливает не только всплытие, но и выполнение других обработчиков на том же элементе (`child`).

---

### 5. Комбинированный пример (захват, цель, всплытие, остановка)

Этот пример демонстрирует все фазы и остановку всплытия:

```html
<div id="grandparent">
  <div id="parent">
    <button id="child">Кликни меня</button>
  </div>
</div>
<script>
  const grandparent = document.querySelector('#grandparent');
  const parent = document.querySelector('#parent');
  const child = document.querySelector('#child');

  // Фаза захвата
  grandparent.addEventListener(
    'click',
    () => {
      console.log('Grandparent (захват)');
    },
    { capture: true }
  );

  parent.addEventListener(
    'click',
    () => {
      console.log('Parent (захват)');
    },
    { capture: true }
  );

  // Фаза цели
  child.addEventListener('click', (event) => {
    console.log('Child (цель)');
    event.stopPropagation(); // Останавливаем всплытие
  });

  // Фаза всплытия
  parent.addEventListener('click', () => {
    console.log('Parent (всплытие)'); // Не сработает
  });

  grandparent.addEventListener('click', () => {
    console.log('Grandparent (всплытие)'); // Не сработает
  });
</script>
```

**Вывод при клике на кнопку**:
```
Grandparent (захват)
Parent (захват)
Child (цель)
```

**Что происходит**:
1. Событие начинается с `document` и движется вниз (фаза захвата).
2. Обработчики на `grandparent` и `parent` срабатывают на фазе захвата.
3. Событие достигает `child` (фаза цели), и его обработчик срабатывает.
4. `event.stopPropagation()` предотвращает всплытие, поэтому обработчики на фазе всплытия (`parent` и `grandparent`) не вызываются.

---

### 6. Особенности и рекомендации:

1. **Когда использовать фазу захвата**:
   - Для перехвата событий до их достижения цели (например, для логирования или предотвращения обработки).
   - Для обработки событий на родительских элементах, если дочерние элементы могут остановить всплытие.

2. **Когда использовать фазу всплытия**:
   - Для делегирования событий (обработка событий на родительском элементе вместо множества дочерних).
   - Для большинства сценариев, так как это поведение по умолчанию.

3. **Остановка всплытия**:
   - Используйте `stopPropagation` с осторожностью, чтобы не нарушить логику других обработчиков.
   - `stopImmediatePropagation` полезен, если нужно полностью прервать обработку события.

4. **Производительность**:
   - Чрезмерное использование обработчиков на фазе захвата может усложнить отладку.
   - Для событий, срабатывающих часто (например, `mousemove`), используйте делегирование или пассивные обработчики (`{ passive: true }`).

5. **Кроссбраузерность**:
   - Механизм захвата и всплытия стандартизирован и поддерживается всеми современными браузерами.
   - В старых браузерах (например, IE8) поддержка ограничена, и может потребоваться использование полифиллов или альтернативных подходов.

---

### Итог:

- **Фаза захвата**: Событие движется от `document` к целевому элементу; обработчики регистрируются с `{ capture: true }`.
- **Фаза цели**: Событие обрабатывается на целевом элементе.
- **Фаза всплытия**: Событие движется от целевого элемента к `document`; это поведение по умолчанию.
- **Остановка всплытия**: Используйте `event.stopPropagation()` для остановки всплытия или `event.stopImmediatePropagation()` для полной остановки обработки.