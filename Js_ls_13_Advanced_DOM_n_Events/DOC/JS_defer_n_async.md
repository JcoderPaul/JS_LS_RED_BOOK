Атрибуты `defer` и `async` в теге `<script>` используются для управления загрузкой и выполнением JavaScript-скриптов в HTML-документе, позволяя оптимизировать процесс загрузки страницы. 

Они влияют на то, как и когда скрипты загружаются и выполняются относительно парсинга HTML и построения DOM, что является частью жизненного цикла HTML-документа. 

Вопрос о том, что лучше — `defer` или `async`, зависит от конкретного сценария использования. 

---

### 1. Как работают `defer` и `async`:

По умолчанию, когда браузер встречает тег `<script>` без атрибутов, он загружает и выполняет скрипт синхронно, блокируя парсинг HTML до завершения выполнения. Это может замедлить загрузку страницы, особенно если скрипты большие или медленно загружаются. 

Атрибуты `defer` и `async` решают эту проблему, позволяя загружать скрипты асинхронно, но с разным поведением.

#### 1.1. Атрибут `async`:
- **Описание**:
  - Скрипт загружается **асинхронно**, параллельно с парсингом HTML.
  - Как только скрипт загружен, он **выполняется немедленно**, временно приостанавливая парсинг HTML.
  - Порядок выполнения скриптов с `async` **не гарантируется** — скрипты выполняются в порядке их загрузки.
- **Жизненный цикл**:
  - Загрузка: Параллельно с HTML.
  - Выполнение: Сразу после загрузки, независимо от состояния DOM.
  - Влияние на `DOMContentLoaded`: Может сработать до или после `DOMContentLoaded`, в зависимости от скорости загрузки.

**Пример**:

  ```html
  <head>
    <script async src="analytics.js"></script>
  </head>

<body>
    <h1>Пример</h1>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM загружен');
      });
    </script>
  </body>
  ```
  **Вывод (зависит от скорости загрузки)**:
  ```
  [analytics.js выполняется]
  DOM загружен
  ```

#### 1.2. Атрибут `defer`:
- **Описание**:
  - Скрипт загружается **асинхронно**, параллельно с парсингом HTML.
  - Выполнение откладывается до момента, когда **DOM полностью построен** (перед событием `DOMContentLoaded`).
  - Порядок выполнения скриптов с `defer` **сохраняется** в соответствии с их порядком в HTML.
- **Жизненный цикл**:
  - Загрузка: Параллельно с HTML.
  - Выполнение: После построения DOM, перед `DOMContentLoaded`.
  - Влияние на `DOMContentLoaded`: Выполнение всех `defer`-скриптов завершается до `DOMContentLoaded`.

**Пример**:

  ```html
  <head>
    <script defer src="script1.js"></script>
    <script defer src="script2.js"></script>
  </head>

  <body>
    <h1>Пример</h1>
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM загружен');
      });
    </script>
  </body>
  ```
  **Вывод**:
  ```
  [script1.js выполняется]
  [script2.js выполняется]
  DOM загружен
  ```

---

### 2. Сравнение `defer` и `async`:

| Характеристика              | `async`                              | `defer`                              |
|-----------------------------|--------------------------------------|--------------------------------------|
| **Загрузка**                | Асинхронная (параллельно с HTML)    | Асинхронная (параллельно с HTML)    |
| **Выполнение**              | Сразу после загрузки                | После построения DOM                |
| **Порядок выполнения**      | Не гарантирован                     | Сохраняется (в порядке HTML)        |
| **Блокировка парсинга HTML**| Прерывает парсинг при выполнении    | Не прерывает парсинг                |
| **Зависимость от DOM**      | Не гарантирует готовность DOM       | Гарантирует готовность DOM          |
| **Примеры использования**   | Аналитика, трекинг, независимые виджеты | Скрипты для DOM, библиотеки (jQuery) |

**Визуализация**:
```
HTML:       |-------- Парсинг HTML --------|
async:      | Загрузка | Выполнение |
defer:      | Загрузка |                   | Выполнение |
DOMContentLoaded:                         | X |
```

---

### 3. Когда использовать `defer` и `async`:

#### 3.1. Используйте `async`, если:

- Скрипт **независим** от DOM и других скриптов (например, аналитика, рекламные виджеты).
- Вы хотите, чтобы скрипт выполнился как можно скорее, независимо от состояния DOM.
- Порядок выполнения скрипта не важен.

**Пример использования**:

```html
<head>
  <script async src="https://analytics.example.com/tracker.js"></script>
</head>
```
- `tracker.js` загружается и выполняется независимо от DOM, отправляя данные аналитики.

#### 3.2. Используйте `defer`, если:

- Скрипт **зависит от DOM** (например, манипуляции с элементами страницы).
- Важно сохранить **порядок выполнения** нескольких скриптов.
- Вы хотите минимизировать влияние на рендеринг страницы.

**Пример использования**:

```html
<head>
  <script defer src="app.js"></script>
</head>

<body>
  <div id="content">Контент</div>
</body>
```

```javascript
// app.js
document.querySelector('#content').textContent = 'Обновлено!';
```
- `app.js` выполняется после построения DOM, гарантируя доступ к `#content`.

---

### 4. Что лучше: `defer` или `async`?

Выбор между `defer` и `async` зависит от ваших потребностей:

#### 4.1. `defer` предпочтительнее в большинстве случаев:

- **Почему**:
  - Гарантирует, что скрипт выполнится после построения DOM, что делает его безопасным для работы с элементами страницы.
  - Сохраняет порядок выполнения скриптов, что важно, если один скрипт зависит от другого (например, библиотека и код, её использующий).
  - Не прерывает парсинг HTML, обеспечивая более плавное отображение страницы.
- **Когда выбрать**:
  - Для большинства приложений, особенно если скрипты взаимодействуют с DOM (например, добавление обработчиков событий, изменение элементов).
  - Для библиотек (например, jQuery, React), которые должны загружаться в определённом порядке.

#### 4.2. `async` лучше для независимых скриптов:

- **Почему**:
  - Позволяет скрипту выполняться сразу после загрузки, что полезно для задач, не связанных с DOM (например, аналитика или загрузка рекламы).
  - Ускоряет выполнение независимых скриптов, так как не ждёт построения DOM.
- **Когда выбрать**:
  - Для сторонних скриптов, таких как Google Analytics, рекламные сети или виджеты, которые не зависят от DOM или других скриптов.
  - Когда порядок выполнения не важен.

#### 4.3. Альтернативы:

- **Без атрибутов (`<script>` в конце `<body>`)**:
  - Если скрипт небольшой или его нельзя сделать асинхронным, поместите `<script>` в конец `<body>`. Это гарантирует, что DOM уже построен, но блокирует парсинг HTML.
 
  **Пример**:

    ```html
    <body>
      <h1>Пример</h1>
      <script src="app.js"></script>
    </body>
    ```
- **Динамическая загрузка**:
  - Для динамического добавления скриптов используйте JavaScript:
 
    ```javascript
    const script = document.createElement('script');
    script.src = 'dynamic.js';
    script.async = false; // Эмулируем defer
    document.head.appendChild(script);
    ```

---

### 5. Практические примеры:

#### Пример 1: `defer` для работы с DOM

```html
<head>
  <script defer src="app.js"></script>
</head>

<body>
  <button id="myButton">Кликни</button>
</body>
```

```javascript
// app.js
document.addEventListener('DOMContentLoaded', () => {
  document.querySelector('#myButton').addEventListener('click', () => {
    console.log('Кнопка нажата');
  });
});
```
- **Почему `defer`**: Скрипт ждёт построения DOM, чтобы безопасно привязать обработчик к кнопке.

#### Пример 2: `async` для аналитики

```html
<head>
  <script async src="https://analytics.example.com/tracker.js"></script>
</head>
```
- **Почему `async`**: Аналитика не зависит от DOM и должна выполняться как можно скорее.

#### Пример 3: Комбинирование `defer` и `async`

```html
<head>
  <script async src="analytics.js"></script>
  <script defer src="library.js"></script>
  <script defer src="app.js"></script>
</head>
<body>
  <div id="content">Контент</div>
</body>
```
```javascript
// library.js
console.log('Библиотека загружена');

// app.js
document.querySelector('#content').textContent = 'Обновлено!';
```
- **Что происходит**:
  - `analytics.js` загружается и выполняется асинхронно, независимо от DOM.
  - `library.js` и `app.js` загружаются асинхронно, но выполняются в порядке их указания после построения DOM.

**Вывод (примерный)**:
```
[analytics.js выполняется]
[library.js выполняется]
[app.js выполняется]
```

---

### 6. Преимущества и недостатки:

#### 6.1. `async`
- **Преимущества**:
  - Быстрое выполнение независимых скриптов.
  - Не блокирует парсинг HTML во время загрузки.
- **Недостатки**:
  - Не гарантирует готовность DOM, что может вызвать ошибки при доступе к элементам.
  - Порядок выполнения непредсказуем, что проблематично для зависимых скриптов.

#### 6.2. `defer`
- **Преимущества**:
  - Гарантирует готовность DOM, что делает его безопасным для большинства приложений.
  - Сохраняет порядок выполнения скриптов.
  - Не прерывает парсинг HTML.
- **Недостатки**:
  - Выполнение откладывается до построения DOM, что может быть медленнее для скриптов, не зависящих от DOM.

---

### 7. Особенности и рекомендации:

1. **Выбор между `defer` и `async`**:
   - **По умолчанию используйте `defer`**: Он подходит для большинства случаев, особенно если скрипт взаимодействует с DOM или зависит от других скриптов.
   - Используйте `async` только для независимых скриптов, таких как аналитика или виджеты.

2. **Комбинирование**:
   - Используйте `async` для сторонних скриптов и `defer` для основного кода приложения.
   
   Пример:

     ```html
     <script async src="analytics.js"></script>
     <script defer src="app.js"></script>
     ```

3. **Производительность**:
   - Оба атрибута улучшают скорость загрузки страницы по сравнению с синхронными скриптами.
   - Для критически важных скриптов минимизируйте их размер или используйте встроенные `<script>` в конце `<body>`.

4. **Кроссбраузерность**:
   - `defer` и `async` поддерживаются всеми современными браузерами (Chrome, Firefox, Safari, Edge).
   - В старых браузерах (IE9 и ниже) поддержка ограничена. В таких случаях используйте `<script>` в конце `<body>` или полифиллы.

5. **Обработка ошибок**:
   - Обрабатывайте ошибки загрузки скриптов с помощью события `error`:
   
     ```javascript
     const script = document.querySelector('script');
     script.addEventListener('error', () => {
       console.log('Ошибка загрузки скрипта');
     });
     ```

6. **Связь с жизненным циклом HTML-документа**:
   - `defer` гарантирует выполнение перед `DOMContentLoaded`, что идеально для скриптов, зависящих от DOM.
   - `async` может выполняться до или после `DOMContentLoaded`, что требует осторожности при работе с DOM.

7. **Динамическая загрузка**:
   - При динамическом добавлении скриптов `async` включён по умолчанию. Для поведения, аналогичного `defer`, установите `async = false`:
   
     ```javascript
     const script = document.createElement('script');
     script.src = 'dynamic.js';
     script.async = false;
     document.head.appendChild(script);
     ```

---

### Итог:

- **`defer`** лучше в большинстве случаев, так как:
  - Гарантирует готовность DOM.
  - Сохраняет порядок выполнения скриптов.
  - Не прерывает парсинг HTML.
  - Подходит для скриптов, работающих с DOM или зависящих от других скриптов.
- **`async`** лучше для:
  - Независимых скриптов, таких как аналитика или сторонние виджеты.
  - Случаев, где порядок выполнения не важен.
- **Альтернатива**: Размещение `<script>` в конце `<body>` для небольших скриптов или старых браузеров.

Для выбора оптимального подхода учитывайте, нужен ли скрипту доступ к DOM и есть ли зависимости между скриптами. 

Для дополнительной информации рекомендую [MDN Web Docs: <script> element](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/script).